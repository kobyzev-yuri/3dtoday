# –°—Ç—Ä–∞—Ç–µ–≥–∏—è –ø–∞—Ä—Å–∏–Ω–≥–∞, —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –∏ –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä—ã –∞–≥–µ–Ω—Ç–æ–≤

## üìã –°–æ–¥–µ—Ä–∂–∞–Ω–∏–µ

1. [–ò–Ω—Ç–µ–ª–ª–µ–∫—Ç—É–∞–ª—å–Ω—ã–π –ø–∞—Ä—Å–∏–Ω–≥ —Å–∞–π—Ç–∞ 3dtoday.ru](#1-–∏–Ω—Ç–µ–ª–ª–µ–∫—Ç—É–∞–ª—å–Ω—ã–π-–ø–∞—Ä—Å–∏–Ω–≥-—Å–∞–π—Ç–∞-3dtodayru)
2. [–¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ KB –Ω–∞ —Ä–µ–ª–µ–≤–∞–Ω—Ç–Ω–æ—Å—Ç—å](#2-—Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ-kb-–Ω–∞-—Ä–µ–ª–µ–≤–∞–Ω—Ç–Ω–æ—Å—Ç—å)
3. [–ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞ –≤–∑–∞–∏–º–æ–¥–µ–π—Å—Ç–≤–∏—è –∞–≥–µ–Ω—Ç–æ–≤](#3-–∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞-–≤–∑–∞–∏–º–æ–¥–µ–π—Å—Ç–≤–∏—è-–∞–≥–µ–Ω—Ç–æ–≤)

---

## 1. –ò–Ω—Ç–µ–ª–ª–µ–∫—Ç—É–∞–ª—å–Ω—ã–π –ø–∞—Ä—Å–∏–Ω–≥ —Å–∞–π—Ç–∞ 3dtoday.ru

### 1.1 –¶–µ–ª—å –ø–∞—Ä—Å–∏–Ω–≥–∞

**–ó–∞–¥–∞—á–∞:** –ò–∑–≤–ª–µ—á—å —Ç–æ–ª—å–∫–æ —Ä–µ–ª–µ–≤–∞–Ω—Ç–Ω—É—é –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é, —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É—é—â—É—é –∑–∞–¥–∞—á–∞–º –ø—Ä–æ–µ–∫—Ç–∞, –º–∏–Ω–∏–º–∏–∑–∏—Ä–æ–≤–∞–≤ –∑–∞–≥—Ä—É–∑–∫—É "–º—É—Å–æ—Ä–∞" –≤ KB.

**–ö—Ä–∏—Ç–µ—Ä–∏–∏ —Ä–µ–ª–µ–≤–∞–Ω—Ç–Ω–æ—Å—Ç–∏:**
- ‚úÖ –°—Ç–∞—Ç—å–∏ –ø–æ –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–µ –∏ —Ä–µ—à–µ–Ω–∏—é –ø—Ä–æ–±–ª–µ–º 3D-–ø–µ—á–∞—Ç–∏
- ‚úÖ –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –Ω–∞—Å—Ç—Ä–æ–π–∫–µ –ø—Ä–∏–Ω—Ç–µ—Ä–æ–≤ –∏ –º–∞—Ç–µ—Ä–∏–∞–ª–æ–≤
- ‚úÖ –†–µ–∞–ª—å–Ω—ã–µ –∫–µ–π—Å—ã —Å –ø—Ä–æ–±–ª–µ–º–∞–º–∏ –∏ —Ä–µ—à–µ–Ω–∏—è–º–∏
- ‚ùå –ê–∫—Ü–∏–∏, –æ–±—ä—è–≤–ª–µ–Ω–∏—è, –æ–±—Å—É–∂–¥–µ–Ω–∏—è –±–µ–∑ —Ç–µ—Ö–Ω–∏—á–µ—Å–∫–æ–π —Ü–µ–Ω–Ω–æ—Å—Ç–∏
- ‚ùå –£—Å—Ç–∞—Ä–µ–≤—à–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è (—Å—Ç–∞—Ä—ã–µ –º–æ–¥–µ–ª–∏ –ø—Ä–∏–Ω—Ç–µ—Ä–æ–≤)

### 1.2 –ú–Ω–æ–≥–æ—É—Ä–æ–≤–Ω–µ–≤–∞—è —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏—è

#### –£—Ä–æ–≤–µ–Ω—å 1: –°—Ç—Ä—É–∫—Ç—É—Ä–Ω–∞—è —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏—è (–¥–æ –ø–∞—Ä—Å–∏–Ω–≥–∞)

**–§–∏–ª—å—Ç—Ä–∞—Ü–∏—è –ø–æ —Ä–∞–∑–¥–µ–ª–∞–º —Å–∞–π—Ç–∞:**

```python
RELEVANT_SECTIONS = {
    "–¢–µ—Ö–Ω–∏—á–∫–∞": {
        "priority": "high",
        "subsections": ["–ù–∞—Å—Ç—Ä–æ–π–∫–∞", "–£—Å—Ç—Ä–∞–Ω–µ–Ω–∏–µ –Ω–µ–ø–æ–ª–∞–¥–æ–∫", "–ö–∞–ª–∏–±—Ä–æ–≤–∫–∞"]
    },
    "3D-–ø–µ—á–∞—Ç—å": {
        "priority": "high",
        "subsections": ["–ú–µ—Ç–æ–¥–∏–∫–∏", "–¢–µ—Ö–Ω–æ–ª–æ–≥–∏–∏", "–ú–∞—Ç–µ—Ä–∏–∞–ª—ã"]
    },
    "3d-–û–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏–µ ‚Üí 3D-–ø—Ä–∏–Ω—Ç–µ—Ä—ã": {
        "priority": "medium",
        "subsections": ["–•–∞—Ä–∞–∫—Ç–µ—Ä–∏—Å—Ç–∏–∫–∏", "–ù–∞—Å—Ç—Ä–æ–π–∫–∞", "–ü—Ä–æ–±–ª–µ–º—ã"]
    },
    "–†–∞—Å—Ö–æ–¥–Ω—ã–µ –º–∞—Ç–µ—Ä–∏–∞–ª—ã": {
        "priority": "high",
        "subsections": ["PLA", "PETG", "ABS", "–ù–∞—Å—Ç—Ä–æ–π–∫–∏"]
    },
    "–ü—Ä–∏–º–µ–Ω–µ–Ω–∏–µ": {
        "priority": "medium",
        "subsections": ["–ö–µ–π—Å—ã", "–ü—Ä–æ–±–ª–µ–º—ã –∏ —Ä–µ—à–µ–Ω–∏—è"]
    },
    "–õ–∏—á–Ω—ã–µ –¥–Ω–µ–≤–Ω–∏–∫–∏": {
        "priority": "low",
        "filter": "only_technical_content"  # –¢–æ–ª—å–∫–æ —Ç–µ—Ö–Ω–∏—á–µ—Å–∫–∏–µ –ø–æ—Å—Ç—ã
    }
}

EXCLUDED_SECTIONS = [
    "–ê–∫—Ü–∏–∏",
    "–ü–µ—Å–æ—á–Ω–∏—Ü–∞",
    "–ß–∞—Å—Ç–Ω—ã–µ –æ–±—ä—è–≤–ª–µ–Ω–∏—è",
    "–ù–æ–≤–æ—Å—Ç–∏",
    "–§–æ—Ä—É–º (–æ–±—â–∏–µ –æ–±—Å—É–∂–¥–µ–Ω–∏—è)"
]
```

**–†–µ–∞–ª–∏–∑–∞—Ü–∏—è:**

```python
class SectionFilter:
    def __init__(self):
        self.relevant_sections = RELEVANT_SECTIONS
        self.excluded_sections = EXCLUDED_SECTIONS
    
    def is_relevant(self, url: str, section: str) -> bool:
        """–ü—Ä–æ–≤–µ—Ä–∫–∞ —Ä–µ–ª–µ–≤–∞–Ω—Ç–Ω–æ—Å—Ç–∏ —Ä–∞–∑–¥–µ–ª–∞"""
        if section in self.excluded_sections:
            return False
        
        if section in self.relevant_sections:
            return True
        
        return False
    
    def get_priority(self, section: str) -> str:
        """–ü–æ–ª—É—á–∏—Ç—å –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç —Ä–∞–∑–¥–µ–ª–∞"""
        return self.relevant_sections.get(section, {}).get("priority", "low")
```

#### –£—Ä–æ–≤–µ–Ω—å 2: –ö–æ–Ω—Ç–µ–Ω—Ç–Ω–∞—è —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏—è (–ø–æ—Å–ª–µ –ø–∞—Ä—Å–∏–Ω–≥–∞)

**–ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ LLM –¥–ª—è –∞–Ω–∞–ª–∏–∑–∞ —Ä–µ–ª–µ–≤–∞–Ω—Ç–Ω–æ—Å—Ç–∏:**

```python
class ContentRelevanceFilter:
    def __init__(self, llm_client):
        self.llm = llm_client
    
    async def analyze_relevance(self, article_content: str, metadata: dict) -> dict:
        """–ê–Ω–∞–ª–∏–∑ —Ä–µ–ª–µ–≤–∞–Ω—Ç–Ω–æ—Å—Ç–∏ —Å—Ç–∞—Ç—å–∏ —Å –ø–æ–º–æ—â—å—é LLM"""
        
        prompt = f"""
–ü—Ä–æ–∞–Ω–∞–ª–∏–∑–∏—Ä—É–π —Å—Ç–∞—Ç—å—é –∏ –æ–ø—Ä–µ–¥–µ–ª–∏ –µ—ë —Ä–µ–ª–µ–≤–∞–Ω—Ç–Ω–æ—Å—Ç—å –¥–ª—è —Å–∏—Å—Ç–µ–º—ã –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∏ –ø—Ä–æ–±–ª–µ–º 3D-–ø–µ—á–∞—Ç–∏.

–°–¢–ê–¢–¨–Ø:
{article_content[:2000]}

–ú–ï–¢–ê–î–ê–ù–ù–´–ï:
- –†–∞–∑–¥–µ–ª: {metadata.get('section')}
- –ó–∞–≥–æ–ª–æ–≤–æ–∫: {metadata.get('title')}
- –î–∞—Ç–∞: {metadata.get('date')}

–ö–†–ò–¢–ï–†–ò–ò –†–ï–õ–ï–í–ê–ù–¢–ù–û–°–¢–ò:
1. –°–æ–¥–µ—Ä–∂–∏—Ç –ª–∏ —Å—Ç–∞—Ç—å—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –ø—Ä–æ–±–ª–µ–º–∞—Ö 3D-–ø–µ—á–∞—Ç–∏?
2. –ï—Å—Ç—å –ª–∏ –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã–µ —Ä–µ—à–µ–Ω–∏—è –∏–ª–∏ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏?
3. –£–ø–æ–º–∏–Ω–∞—é—Ç—Å—è –ª–∏ –º–æ–¥–µ–ª–∏ –ø—Ä–∏–Ω—Ç–µ—Ä–æ–≤, –º–∞—Ç–µ—Ä–∏–∞–ª—ã, –ø–∞—Ä–∞–º–µ—Ç—Ä—ã?
4. –Ø–≤–ª—è–µ—Ç—Å—è –ª–∏ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –∞–∫—Ç—É–∞–ª—å–Ω–æ–π –∏ –ø–æ–ª–µ–∑–Ω–æ–π?

–í–µ—Ä–Ω–∏ JSON:
{{
    "relevant": true/false,
    "relevance_score": 0.0-1.0,
    "problem_types": ["stringing", "warping", ...],
    "printer_models": ["Ender-3", ...],
    "materials": ["PLA", "PETG", ...],
    "has_solutions": true/false,
    "has_parameters": true/false,
    "reason": "–ø–æ—á–µ–º—É —Ä–µ–ª–µ–≤–∞–Ω—Ç–Ω–∞/–Ω–µ —Ä–µ–ª–µ–≤–∞–Ω—Ç–Ω–∞"
}}
"""
        
        response = await self.llm.generate(prompt)
        return json.loads(response)
    
    def should_include(self, analysis: dict, min_score: float = 0.7) -> bool:
        """–†–µ—à–µ–Ω–∏–µ –æ –≤–∫–ª—é—á–µ–Ω–∏–∏ —Å—Ç–∞—Ç—å–∏ –≤ KB"""
        if not analysis.get("relevant", False):
            return False
        
        if analysis.get("relevance_score", 0.0) < min_score:
            return False
        
        # –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –ø—Ä–æ–≤–µ—Ä–∫–∏
        if not analysis.get("has_solutions", False):
            return False  # –ù—É–∂–Ω—ã –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã–µ —Ä–µ—à–µ–Ω–∏—è
        
        return True
```

#### –£—Ä–æ–≤–µ–Ω—å 3: –ò–∑–≤–ª–µ—á–µ–Ω–∏–µ —Å—Ç—Ä—É–∫—Ç—É—Ä–∏—Ä–æ–≤–∞–Ω–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö

**–ü–∞—Ä—Å–∏–Ω–≥ –º–µ—Ç–∞–¥–∞–Ω–Ω—ã—Ö –∏–∑ —Å—Ç–∞—Ç—å–∏:**

```python
class ArticleMetadataExtractor:
    def __init__(self, llm_client):
        self.llm = llm_client
    
    async def extract_metadata(self, article_content: str, url: str) -> dict:
        """–ò–∑–≤–ª–µ—á–µ–Ω–∏–µ —Å—Ç—Ä—É–∫—Ç—É—Ä–∏—Ä–æ–≤–∞–Ω–Ω—ã—Ö –º–µ—Ç–∞–¥–∞–Ω–Ω—ã—Ö –∏–∑ —Å—Ç–∞—Ç—å–∏"""
        
        prompt = f"""
–ò–∑–≤–ª–µ–∫–∏ —Å—Ç—Ä—É–∫—Ç—É—Ä–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ –º–µ—Ç–∞–¥–∞–Ω–Ω—ã–µ –∏–∑ —Å—Ç–∞—Ç—å–∏ –æ 3D-–ø–µ—á–∞—Ç–∏.

–°–¢–ê–¢–¨–Ø:
{article_content[:3000]}

–ò–∑–≤–ª–µ–∫–∏:
1. –¢–∏–ø—ã –ø—Ä–æ–±–ª–µ–º (problem_type): stringing, warping, layer_separation, etc.
2. –ú–æ–¥–µ–ª–∏ –ø—Ä–∏–Ω—Ç–µ—Ä–æ–≤ (printer_models): Ender-3, Anycubic Kobra, etc.
3. –ú–∞—Ç–µ—Ä–∏–∞–ª—ã (materials): PLA, PETG, ABS, etc.
4. –°–∏–º–ø—Ç–æ–º—ã (symptoms): ["–Ω–∏—Ç–æ—á–∫–∏", "–æ—Ç—Å–ª–æ–µ–Ω–∏–µ", ...]
5. –†–µ—à–µ–Ω–∏—è (solutions): [{{"parameter": "retraction_length", "value": 6, ...}}]
6. –≠—Ç–∞–ø –ø–µ—á–∞—Ç–∏ (print_stage): first_layer, infill, etc.

–í–µ—Ä–Ω–∏ JSON:
{{
    "problem_type": "stringing",
    "printer_models": ["Ender-3"],
    "materials": ["PLA"],
    "symptoms": ["–Ω–∏—Ç–æ—á–∫–∏", "—Å–æ–ø–ª–∏"],
    "solutions": [
        {{
            "parameter": "retraction_length",
            "value": 6,
            "unit": "mm",
            "description": "–£–≤–µ–ª–∏—á—å—Ç–µ retraction –¥–æ 6 –º–º"
        }}
    ],
    "print_stage": ["first_layer"],
    "related_problems": ["warping", "overheating"]
}}
"""
        
        response = await self.llm.generate(prompt)
        return json.loads(response)
```

### 1.3 –ü–∞—Ä—Å–µ—Ä —Å –∏–Ω—Ç–µ–ª–ª–µ–∫—Ç—É–∞–ª—å–Ω–æ–π —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏–µ–π

**–ü–æ–ª–Ω—ã–π pipeline –ø–∞—Ä—Å–∏–Ω–≥–∞:**

```python
class IntelligentScraper:
    def __init__(self, llm_client, vector_db):
        self.section_filter = SectionFilter()
        self.relevance_filter = ContentRelevanceFilter(llm_client)
        self.metadata_extractor = ArticleMetadataExtractor(llm_client)
        self.vector_db = vector_db
    
    async def scrape_article(self, url: str) -> Optional[dict]:
        """–ü–∞—Ä—Å–∏–Ω–≥ —Å—Ç–∞—Ç—å–∏ —Å –º–Ω–æ–≥–æ—É—Ä–æ–≤–Ω–µ–≤–æ–π —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏–µ–π"""
        
        # 1. –ü–æ–ª—É—á–µ–Ω–∏–µ HTML
        html = await self.fetch_html(url)
        
        # 2. –°—Ç—Ä—É–∫—Ç—É—Ä–Ω–∞—è —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏—è
        section = self.extract_section(html)
        if not self.section_filter.is_relevant(url, section):
            logger.info(f"‚è≠Ô∏è –ü—Ä–æ–ø—É—â–µ–Ω–∞ —Å—Ç–∞—Ç—å—è: {url} (—Ä–∞–∑–¥–µ–ª: {section})")
            return None
        
        # 3. –ò–∑–≤–ª–µ—á–µ–Ω–∏–µ –∫–æ–Ω—Ç–µ–Ω—Ç–∞
        article_content = self.extract_content(html)
        metadata = {
            "url": url,
            "section": section,
            "title": self.extract_title(html),
            "date": self.extract_date(html)
        }
        
        # 4. –ê–Ω–∞–ª–∏–∑ —Ä–µ–ª–µ–≤–∞–Ω—Ç–Ω–æ—Å—Ç–∏
        relevance_analysis = await self.relevance_filter.analyze_relevance(
            article_content, metadata
        )
        
        if not self.relevance_filter.should_include(relevance_analysis):
            logger.info(f"‚è≠Ô∏è –ü—Ä–æ–ø—É—â–µ–Ω–∞ —Å—Ç–∞—Ç—å—è: {url} (score: {relevance_analysis['relevance_score']})")
            return None
        
        # 5. –ò–∑–≤–ª–µ—á–µ–Ω–∏–µ —Å—Ç—Ä—É–∫—Ç—É—Ä–∏—Ä–æ–≤–∞–Ω–Ω—ã—Ö –º–µ—Ç–∞–¥–∞–Ω–Ω—ã—Ö
        structured_metadata = await self.metadata_extractor.extract_metadata(
            article_content, url
        )
        
        # 6. –§–æ—Ä–º–∏—Ä–æ–≤–∞–Ω–∏–µ —Ñ–∏–Ω–∞–ª—å–Ω–æ–≥–æ –æ–±—ä–µ–∫—Ç–∞
        article = {
            "url": url,
            "title": metadata["title"],
            "content": article_content,
            "section": section,
            "date": metadata["date"],
            "relevance_score": relevance_analysis["relevance_score"],
            "problem_type": structured_metadata.get("problem_type"),
            "printer_models": structured_metadata.get("printer_models", []),
            "materials": structured_metadata.get("materials", []),
            "symptoms": structured_metadata.get("symptoms", []),
            "solutions": structured_metadata.get("solutions", []),
            "print_stage": structured_metadata.get("print_stage", []),
            "related_problems": structured_metadata.get("related_problems", [])
        }
        
        logger.info(f"‚úÖ –°—Ç–∞—Ç—å—è –¥–æ–±–∞–≤–ª–µ–Ω–∞: {url} (score: {relevance_analysis['relevance_score']:.2f})")
        return article
    
    async def scrape_section(self, section_url: str, max_articles: int = 100):
        """–ü–∞—Ä—Å–∏–Ω–≥ —Ä–∞–∑–¥–µ–ª–∞ —Å –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–µ–º –∫–æ–ª–∏—á–µ—Å—Ç–≤–∞"""
        articles = []
        page = 1
        
        while len(articles) < max_articles:
            page_url = f"{section_url}?page={page}"
            article_urls = await self.extract_article_urls(page_url)
            
            if not article_urls:
                break
            
            for url in article_urls:
                if len(articles) >= max_articles:
                    break
                
                article = await self.scrape_article(url)
                if article:
                    articles.append(article)
                    # –ù–µ–±–æ–ª—å—à–∞—è –∑–∞–¥–µ—Ä–∂–∫–∞ –º–µ–∂–¥—É –∑–∞–ø—Ä–æ—Å–∞–º–∏
                    await asyncio.sleep(1)
            
            page += 1
        
        return articles
```

### 1.4 –ü—Ä–∏–æ—Ä–∏—Ç–∏–∑–∞—Ü–∏—è –ø–∞—Ä—Å–∏–Ω–≥–∞

**–°—Ç—Ä–∞—Ç–µ–≥–∏—è:**
1. **–í—ã—Å–æ–∫–∏–π –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç** ‚Äî –ø–∞—Ä—Å–∏—Ç—å –ø–µ—Ä–≤—ã–º–∏
   - –¢–µ—Ö–Ω–∏—á–∫–∞ ‚Üí –ù–∞—Å—Ç—Ä–æ–π–∫–∞, –£—Å—Ç—Ä–∞–Ω–µ–Ω–∏–µ –Ω–µ–ø–æ–ª–∞–¥–æ–∫
   - –†–∞—Å—Ö–æ–¥–Ω—ã–µ –º–∞—Ç–µ—Ä–∏–∞–ª—ã ‚Üí PLA, PETG, ABS
   
2. **–°—Ä–µ–¥–Ω–∏–π –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç** ‚Äî –ø–∞—Ä—Å–∏—Ç—å –ø–æ—Å–ª–µ –≤—ã—Å–æ–∫–æ–≥–æ
   - 3D-–ø–µ—á–∞—Ç—å ‚Üí –ú–µ—Ç–æ–¥–∏–∫–∏
   - –ü—Ä–∏–º–µ–Ω–µ–Ω–∏–µ ‚Üí –ö–µ–π—Å—ã
   
3. **–ù–∏–∑–∫–∏–π –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç** ‚Äî –ø–∞—Ä—Å–∏—Ç—å –≤ –ø–æ—Å–ª–µ–¥–Ω—é—é –æ—á–µ—Ä–µ–¥—å
   - –õ–∏—á–Ω—ã–µ –¥–Ω–µ–≤–Ω–∏–∫–∏ (—Ç–æ–ª—å–∫–æ —Ç–µ—Ö–Ω–∏—á–µ—Å–∫–∏–µ –ø–æ—Å—Ç—ã)

**–†–µ–∞–ª–∏–∑–∞—Ü–∏—è:**

```python
async def scrape_with_priority(self):
    """–ü–∞—Ä—Å–∏–Ω–≥ —Å —É—á–µ—Ç–æ–º –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç–æ–≤"""
    
    # –í—ã—Å–æ–∫–∏–π –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç
    high_priority_sections = [
        "–¢–µ—Ö–Ω–∏—á–∫–∞/–ù–∞—Å—Ç—Ä–æ–π–∫–∞",
        "–¢–µ—Ö–Ω–∏—á–∫–∞/–£—Å—Ç—Ä–∞–Ω–µ–Ω–∏–µ –Ω–µ–ø–æ–ª–∞–¥–æ–∫",
        "–†–∞—Å—Ö–æ–¥–Ω—ã–µ –º–∞—Ç–µ—Ä–∏–∞–ª—ã/PLA",
        "–†–∞—Å—Ö–æ–¥–Ω—ã–µ –º–∞—Ç–µ—Ä–∏–∞–ª—ã/PETG"
    ]
    
    for section in high_priority_sections:
        articles = await self.scrape_section(section, max_articles=50)
        await self.index_articles(articles)
    
    # –°—Ä–µ–¥–Ω–∏–π –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç
    medium_priority_sections = [
        "3D-–ø–µ—á–∞—Ç—å/–ú–µ—Ç–æ–¥–∏–∫–∏",
        "–ü—Ä–∏–º–µ–Ω–µ–Ω–∏–µ/–ö–µ–π—Å—ã"
    ]
    
    for section in medium_priority_sections:
        articles = await self.scrape_section(section, max_articles=30)
        await self.index_articles(articles)
```

---

## 2. –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ KB –Ω–∞ —Ä–µ–ª–µ–≤–∞–Ω—Ç–Ω–æ—Å—Ç—å

### 2.1 –ú–µ—Ç–æ–¥–æ–ª–æ–≥–∏—è —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è (–∏–∑ ai_report –∏ steccom-rag-lk)

#### –ú–µ—Ç—Ä–∏–∫–∏ –∫–∞—á–µ—Å—Ç–≤–∞

**1. Top-k Hit Rate (–¢–æ—á–Ω–æ—Å—Ç—å —Ä–µ—Ç—Ä–∏–≤–µ—Ä–∞)**
- **–û–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ:** –î–æ–ª—è –∑–∞–ø—Ä–æ—Å–æ–≤, –≥–¥–µ —Ä–µ–ª–µ–≤–∞–Ω—Ç–Ω–∞—è —Å—Ç–∞—Ç—å—è –ø–æ–ø–∞–ª–∞ –≤ top-k —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤
- **–¶–µ–ª–µ–≤—ã–µ –∑–Ω–∞—á–µ–Ω–∏—è:**
  - Top-1: > 0.6 (60%)
  - Top-3: > 0.8 (80%)
  - Top-5: > 0.9 (90%)

**2. Relevance Score (–û—Ü–µ–Ω–∫–∞ —Ä–µ–ª–µ–≤–∞–Ω—Ç–Ω–æ—Å—Ç–∏)**
- **–û–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ:** –ü—Ä–æ—Ü–µ–Ω—Ç –Ω–∞–π–¥–µ–Ω–Ω—ã—Ö –∫–ª—é—á–µ–≤—ã—Ö —Å–ª–æ–≤ –≤ –æ—Ç–≤–µ—Ç–µ
- **–ú–µ—Ç–æ–¥:** –°—Ä–∞–≤–Ω–µ–Ω–∏–µ –æ–∂–∏–¥–∞–µ–º—ã—Ö –∫–ª—é—á–µ–≤—ã—Ö —Å–ª–æ–≤ —Å –Ω–∞–π–¥–µ–Ω–Ω—ã–º–∏
- **–¶–µ–ª–µ–≤–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ:** > 0.7 (70%)

**3. MRR (Mean Reciprocal Rank)**
- **–û–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ:** –£—Å—Ä–µ–¥–Ω–µ–Ω–Ω–∞—è –æ–±—Ä–∞—Ç–Ω–∞—è –ø–æ–∑–∏—Ü–∏—è –ø–µ—Ä–≤–æ–≥–æ —Ä–µ–ª–µ–≤–∞–Ω—Ç–Ω–æ–≥–æ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞
- **–§–æ—Ä–º—É–ª–∞:** `MRR = (1/n) * Œ£(1/rank_i)`
- **–¶–µ–ª–µ–≤–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ:** > 0.7

**4. Diagnostic Accuracy (–¢–æ—á–Ω–æ—Å—Ç—å –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∏)**
- **–û–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ:** –î–æ–ª—è –ø—Ä–∞–≤–∏–ª—å–Ω—ã—Ö –¥–∏–∞–≥–Ω–æ–∑–æ–≤ –ø—Ä–æ–±–ª–µ–º
- **–ú–µ—Ç–æ–¥:** –°—Ä–∞–≤–Ω–µ–Ω–∏–µ –¥–∏–∞–≥–Ω–æ–∑–∞ —Å–∏—Å—Ç–µ–º—ã —Å —ç—Ç–∞–ª–æ–Ω–Ω—ã–º
- **–¶–µ–ª–µ–≤–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ:** > 0.8 (80%)

### 2.2 –ì–µ–Ω–µ—Ä–∞—Ü–∏—è —Ç–µ—Å—Ç–æ–≤—ã—Ö –≤–æ–ø—Ä–æ—Å–æ–≤

**–ü–æ–¥—Ö–æ–¥ –∏–∑ steccom-rag-lk:**

```python
class RelevanceTestGenerator:
    def __init__(self, llm_client):
        self.llm = llm_client
    
    async def generate_test_questions(self, article: dict) -> List[dict]:
        """–ì–µ–Ω–µ—Ä–∞—Ü–∏—è —Ç–µ—Å—Ç–æ–≤—ã—Ö –≤–æ–ø—Ä–æ—Å–æ–≤ –Ω–∞ –æ—Å–Ω–æ–≤–µ —Å—Ç–∞—Ç—å–∏"""
        
        prompt = f"""
–°–æ–∑–¥–∞–π 5-7 —Ç–µ—Å—Ç–æ–≤—ã—Ö –≤–æ–ø—Ä–æ—Å–æ–≤ –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ —Ä–µ–ª–µ–≤–∞–Ω—Ç–Ω–æ—Å—Ç–∏ —Å—Ç–∞—Ç—å–∏ –≤ –±–∞–∑–µ –∑–Ω–∞–Ω–∏–π.

–°–¢–ê–¢–¨–Ø:
–ó–∞–≥–æ–ª–æ–≤–æ–∫: {article['title']}
–ü—Ä–æ–±–ª–µ–º–∞: {article['problem_type']}
–ü—Ä–∏–Ω—Ç–µ—Ä—ã: {', '.join(article['printer_models'])}
–ú–∞—Ç–µ—Ä–∏–∞–ª—ã: {', '.join(article['materials'])}

–°–û–î–ï–†–ñ–ê–ù–ò–ï:
{article['content'][:2000]}

–¢–†–ï–ë–û–í–ê–ù–ò–Ø:
1. –í–æ–ø—Ä–æ—Å—ã –¥–æ–ª–∂–Ω—ã –ø—Ä–æ–≤–µ—Ä—è—Ç—å —Ä–µ–ª–µ–≤–∞–Ω—Ç–Ω–æ—Å—Ç—å —Å—Ç–∞—Ç—å–∏
2. –ö–∞–∂–¥—ã–π –≤–æ–ø—Ä–æ—Å –¥–æ–ª–∂–µ–Ω –∏–º–µ—Ç—å –æ–∂–∏–¥–∞–µ–º—ã–µ –∫–ª—é—á–µ–≤—ã–µ —Å–ª–æ–≤–∞
3. –í–æ–ø—Ä–æ—Å—ã –¥–æ–ª–∂–Ω—ã –±—ã—Ç—å —Ä–µ–∞–ª–∏—Å—Ç–∏—á–Ω—ã–º–∏ (–∫–∞–∫ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏ —Å–ø—Ä–∞—à–∏–≤–∞—é—Ç)
4. –†–∞–∑–Ω–∞—è —Å–ª–æ–∂–Ω–æ—Å—Ç—å: –ø—Ä–æ—Å—Ç—ã–µ –∏ —Å–ª–æ–∂–Ω—ã–µ –≤–æ–ø—Ä–æ—Å—ã

–í–µ—Ä–Ω–∏ JSON:
{{
    "questions": [
        {{
            "question": "–ö–∞–∫ —É—Å—Ç—Ä–∞–Ω–∏—Ç—å stringing –Ω–∞ Ender-3?",
            "expected_keywords": ["retraction", "—Ç–µ–º–ø–µ—Ä–∞—Ç—É—Ä–∞", "6 –º–º"],
            "category": "stringing",
            "difficulty": "medium",
            "expected_answer": "–£–≤–µ–ª–∏—á—å—Ç–µ retraction –¥–æ 6 –º–º..."
        }}
    ]
}}
"""
        
        response = await self.llm.generate(prompt)
        return json.loads(response)["questions"]
```

### 2.3 –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ KB

**–ü–æ–ª–Ω—ã–π pipeline —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è:**

```python
class KBRelevanceTester:
    def __init__(self, rag_service, llm_client):
        self.rag = rag_service
        self.llm = llm_client
        self.test_questions = []
    
    async def test_kb_relevance(self, test_questions: List[dict]) -> dict:
        """–¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ KB –Ω–∞ —Ä–µ–ª–µ–≤–∞–Ω—Ç–Ω–æ—Å—Ç—å"""
        
        results = {
            "total_questions": len(test_questions),
            "top_1_hits": 0,
            "top_3_hits": 0,
            "top_5_hits": 0,
            "avg_relevance_score": 0.0,
            "mrr": 0.0,
            "details": []
        }
        
        for question_data in test_questions:
            question = question_data["question"]
            expected_keywords = question_data["expected_keywords"]
            
            # –ü–æ–∏—Å–∫ –≤ KB
            search_results = await self.rag.search(
                query=question,
                limit=5,
                filters={
                    "problem_type": question_data.get("category"),
                    "printer_models": question_data.get("printer_models", []),
                    "materials": question_data.get("materials", [])
                }
            )
            
            # –ì–µ–Ω–µ—Ä–∞—Ü–∏—è –æ—Ç–≤–µ—Ç–∞
            answer = await self.rag.generate_answer(
                question=question,
                context=search_results
            )
            
            # –û—Ü–µ–Ω–∫–∞ —Ä–µ–ª–µ–≤–∞–Ω—Ç–Ω–æ—Å—Ç–∏
            relevance_score = self._calculate_relevance_score(
                answer, expected_keywords
            )
            
            # –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–æ–ø–∞–¥–∞–Ω–∏—è –≤ top-k
            is_relevant = self._check_relevance(
                search_results, question_data.get("expected_article_id")
            )
            
            rank = self._find_relevant_rank(
                search_results, question_data.get("expected_article_id")
            )
            
            # –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –º–µ—Ç—Ä–∏–∫
            if rank == 1:
                results["top_1_hits"] += 1
            if rank <= 3:
                results["top_3_hits"] += 1
            if rank <= 5:
                results["top_5_hits"] += 1
            
            if rank > 0:
                results["mrr"] += 1.0 / rank
            
            results["avg_relevance_score"] += relevance_score
            
            results["details"].append({
                "question": question,
                "relevance_score": relevance_score,
                "rank": rank,
                "is_relevant": is_relevant
            })
        
        # –ù–æ—Ä–º–∞–ª–∏–∑–∞—Ü–∏—è –º–µ—Ç—Ä–∏–∫
        results["top_1_hits"] /= results["total_questions"]
        results["top_3_hits"] /= results["total_questions"]
        results["top_5_hits"] /= results["total_questions"]
        results["mrr"] /= results["total_questions"]
        results["avg_relevance_score"] /= results["total_questions"]
        
        return results
    
    def _calculate_relevance_score(self, answer: str, expected_keywords: List[str]) -> float:
        """–†–∞—Å—á–µ—Ç –æ—Ü–µ–Ω–∫–∏ —Ä–µ–ª–µ–≤–∞–Ω—Ç–Ω–æ—Å—Ç–∏ –ø–æ –∫–ª—é—á–µ–≤—ã–º —Å–ª–æ–≤–∞–º"""
        answer_lower = answer.lower()
        found_keywords = sum(1 for kw in expected_keywords if kw.lower() in answer_lower)
        return found_keywords / len(expected_keywords) if expected_keywords else 0.0
    
    def _check_relevance(self, results: List[dict], expected_id: str) -> bool:
        """–ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞–ª–∏—á–∏—è —Ä–µ–ª–µ–≤–∞–Ω—Ç–Ω–æ–π —Å—Ç–∞—Ç—å–∏ –≤ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞—Ö"""
        if not expected_id:
            return False
        return any(r.get("id") == expected_id for r in results)
    
    def _find_relevant_rank(self, results: List[dict], expected_id: str) -> int:
        """–ü–æ–∏—Å–∫ –ø–æ–∑–∏—Ü–∏–∏ —Ä–µ–ª–µ–≤–∞–Ω—Ç–Ω–æ–π —Å—Ç–∞—Ç—å–∏"""
        if not expected_id:
            return -1
        for i, result in enumerate(results, 1):
            if result.get("id") == expected_id:
                return i
        return -1
```

### 2.4 –ò—Ç–µ—Ä–∞—Ç–∏–≤–Ω–æ–µ —É–ª—É—á—à–µ–Ω–∏–µ KB

**–ü—Ä–æ—Ü–µ—Å—Å –Ω–∞ –æ—Å–Ω–æ–≤–µ –º–µ—Ç—Ä–∏–∫:**

```python
class KBIterativeImprover:
    def __init__(self, kb_tester, scraper):
        self.tester = kb_tester
        self.scraper = scraper
    
    async def improve_kb(self, test_results: dict):
        """–£–ª—É—á—à–µ–Ω–∏–µ KB –Ω–∞ –æ—Å–Ω–æ–≤–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è"""
        
        recommendations = []
        
        # –ê–Ω–∞–ª–∏–∑ —Å–ª–∞–±—ã—Ö –º–µ—Å—Ç
        if test_results["top_1_hits"] < 0.6:
            recommendations.append({
                "issue": "–ù–∏–∑–∫–∞—è —Ç–æ—á–Ω–æ—Å—Ç—å Top-1",
                "action": "–î–æ–±–∞–≤–∏—Ç—å –±–æ–ª—å—à–µ —Å—Ç–∞—Ç–µ–π –ø–æ –ø—Ä–æ–±–ª–µ–º–Ω—ã–º –∫–∞—Ç–µ–≥–æ—Ä–∏—è–º",
                "priority": "high"
            })
        
        if test_results["avg_relevance_score"] < 0.7:
            recommendations.append({
                "issue": "–ù–∏–∑–∫–∞—è —Ä–µ–ª–µ–≤–∞–Ω—Ç–Ω–æ—Å—Ç—å –æ—Ç–≤–µ—Ç–æ–≤",
                "action": "–£–ª—É—á—à–∏—Ç—å –º–µ—Ç–∞–¥–∞–Ω–Ω—ã–µ —Å—Ç–∞—Ç–µ–π, –¥–æ–±–∞–≤–∏—Ç—å –±–æ–ª—å—à–µ –∫–ª—é—á–µ–≤—ã—Ö —Å–ª–æ–≤",
                "priority": "high"
            })
        
        # –ê–Ω–∞–ª–∏–∑ –¥–µ—Ç–∞–ª—å–Ω—ã—Ö —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤
        weak_questions = [
            d for d in test_results["details"]
            if d["relevance_score"] < 0.5 or d["rank"] > 3
        ]
        
        if weak_questions:
            # –û–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –ø—Ä–æ–±–ª–µ–º–Ω—ã—Ö –∫–∞—Ç–µ–≥–æ—Ä–∏–π
            problem_categories = {}
            for q in weak_questions:
                category = q.get("category", "unknown")
                problem_categories[category] = problem_categories.get(category, 0) + 1
            
            # –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏ –ø–æ –ø–∞—Ä—Å–∏–Ω–≥—É
            for category, count in problem_categories.items():
                recommendations.append({
                    "issue": f"–ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ —Å—Ç–∞—Ç–µ–π –ø–æ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏: {category}",
                    "action": f"–ü–∞—Ä—Å–∏—Ç—å –±–æ–ª—å—à–µ —Å—Ç–∞—Ç–µ–π –∏–∑ —Ä–∞–∑–¥–µ–ª–∞ '{category}'",
                    "priority": "medium",
                    "count": count
                })
        
        return recommendations
```

---

## 3. –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞ –≤–∑–∞–∏–º–æ–¥–µ–π—Å—Ç–≤–∏—è –∞–≥–µ–Ω—Ç–æ–≤

### 3.1 –ü—Ä–∏–Ω—Ü–∏–ø—ã —Å–æ–≥–ª–∞—Å–æ–≤–∞–Ω–Ω–æ—Å—Ç–∏

**1. –ï–¥–∏–Ω—ã–π –∫–æ–Ω—Ç–µ–∫—Å—Ç —Å–µ—Å—Å–∏–∏**
- –í—Å–µ –∞–≥–µ–Ω—Ç—ã —Ä–∞–±–æ—Ç–∞—é—Ç —Å –æ–¥–Ω–∏–º –æ–±—ä–µ–∫—Ç–æ–º `SessionContext`
- –ö–æ–Ω—Ç–µ–∫—Å—Ç –ø–µ—Ä–µ–¥–∞–µ—Ç—Å—è –º–µ–∂–¥—É –∞–≥–µ–Ω—Ç–∞–º–∏
- –ò—Å—Ç–æ—Ä–∏—è –¥–∏–∞–ª–æ–≥–∞ —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç—Å—è –≤ –∫–æ–Ω—Ç–µ–∫—Å—Ç–µ

**2. –ß–µ—Ç–∫–∏–µ —Ä–æ–ª–∏ –∞–≥–µ–Ω—Ç–æ–≤**
- –ö–∞–∂–¥—ã–π –∞–≥–µ–Ω—Ç –∏–º–µ–µ—Ç —á–µ—Ç–∫–æ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–Ω—É—é —Ä–æ–ª—å
- –ù–µ—Ç –ø–µ—Ä–µ—Å–µ—á–µ–Ω–∏—è —Ñ—É–Ω–∫—Ü–∏–π –º–µ–∂–¥—É –∞–≥–µ–Ω—Ç–∞–º–∏
- –ê–≥–µ–Ω—Ç—ã –Ω–µ –∫–æ–Ω—Ñ–ª–∏–∫—Ç—É—é—Ç –¥—Ä—É–≥ —Å –¥—Ä—É–≥–æ–º

**3. –°–æ–≥–ª–∞—Å–æ–≤–∞–Ω–Ω—ã–µ –º–µ—Ç–∞–¥–∞–Ω–Ω—ã–µ**
- –ï–¥–∏–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç –º–µ—Ç–∞–¥–∞–Ω–Ω—ã—Ö –¥–ª—è –≤—Å–µ—Ö –∞–≥–µ–Ω—Ç–æ–≤
- –ö–æ–Ω—Å–∏—Å—Ç–µ–Ω—Ç–Ω–∞—è —Å—Ç—Ä—É–∫—Ç—É—Ä–∞ –¥–∞–Ω–Ω—ã—Ö
- –í–∞–ª–∏–¥–∞—Ü–∏—è –¥–∞–Ω–Ω—ã—Ö –º–µ–∂–¥—É –∞–≥–µ–Ω—Ç–∞–º–∏

### 3.2 –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞ –∞–≥–µ–Ω—Ç–æ–≤

```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ  Orchestrator Agent (–≥–ª–∞–≤–Ω—ã–π –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç–æ—Ä)   ‚îÇ
‚îÇ  - –£–ø—Ä–∞–≤–ª—è–µ—Ç –ø–æ—Ç–æ–∫–æ–º –¥–∏–∞–ª–æ–≥–∞                ‚îÇ
‚îÇ  - –†–µ—à–∞–µ—Ç, –∫–∞–∫–æ–π –∞–≥–µ–Ω—Ç –≤—ã–∑–≤–∞—Ç—å              ‚îÇ
‚îÇ  - –ü–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç SessionContext              ‚îÇ
‚îÇ  - –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç –æ—à–∏–±–∫–∏ –∏ fallback           ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
           ‚îÇ
           ‚îú‚îÄ‚îÄ‚îÄ‚ñ∫ Vision Agent
           ‚îÇ     Input: image bytes
           ‚îÇ     Output: {problem_type, symptoms, description}
           ‚îÇ     Context: SessionContext (–¥–æ–±–∞–≤–ª—è–µ—Ç vision_result)
           ‚îÇ
           ‚îú‚îÄ‚îÄ‚îÄ‚ñ∫ Diagnostic Agent
           ‚îÇ     Input: user_input, context
           ‚îÇ     Output: {questions, diagnosis, confidence}
           ‚îÇ     Context: SessionContext (–æ–±–Ω–æ–≤–ª—è–µ—Ç diagnostic_state)
           ‚îÇ
           ‚îî‚îÄ‚îÄ‚îÄ‚ñ∫ Retrieval Agent
                 Input: query, filters
                 Output: {articles, relevance_scores}
                 Context: SessionContext (–∏—Å–ø–æ–ª—å–∑—É–µ—Ç filters –∏–∑ context)
```

### 3.3 SessionContext (–µ–¥–∏–Ω—ã–π –∫–æ–Ω—Ç–µ–∫—Å—Ç)

```python
from dataclasses import dataclass
from typing import Optional, Dict, List, Any
from datetime import datetime

@dataclass
class SessionContext:
    """–ï–¥–∏–Ω—ã–π –∫–æ–Ω—Ç–µ–∫—Å—Ç —Å–µ—Å—Å–∏–∏ –¥–ª—è –≤—Å–µ—Ö –∞–≥–µ–Ω—Ç–æ–≤"""
    
    # –ò–¥–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏—è
    session_id: str
    user_id: Optional[str] = None
    
    # –ò—Å—Ç–æ—Ä–∏—è –¥–∏–∞–ª–æ–≥–∞
    messages: List[Dict[str, Any]] = None
    
    # –°–æ—Å—Ç–æ—è–Ω–∏–µ –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∏
    diagnostic_state: str = "initial"  # initial, collecting_info, diagnosing, solved
    current_problem_type: Optional[str] = None
    collected_info: Dict[str, Any] = None
    
    # –†–µ–∑—É–ª—å—Ç–∞—Ç—ã Vision Agent
    vision_result: Optional[Dict[str, Any]] = None
    
    # –†–µ–∑—É–ª—å—Ç–∞—Ç—ã Retrieval Agent
    retrieved_articles: List[Dict[str, Any]] = None
    
    # –ö–æ–Ω—Ç–µ–∫—Å—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
    printer_model: Optional[str] = None
    material: Optional[str] = None
    print_stage: Optional[str] = None
    
    # –ú–µ—Ç–∞–¥–∞–Ω–Ω—ã–µ
    created_at: datetime = None
    updated_at: datetime = None
    
    def __post_init__(self):
        if self.messages is None:
            self.messages = []
        if self.collected_info is None:
            self.collected_info = {}
        if self.retrieved_articles is None:
            self.retrieved_articles = []
        if self.created_at is None:
            self.created_at = datetime.now()
        if self.updated_at is None:
            self.updated_at = datetime.now()
    
    def add_message(self, role: str, content: str, metadata: Dict = None):
        """–î–æ–±–∞–≤–∏—Ç—å —Å–æ–æ–±—â–µ–Ω–∏–µ –≤ –∏—Å—Ç–æ—Ä–∏—é"""
        self.messages.append({
            "role": role,
            "content": content,
            "timestamp": datetime.now().isoformat(),
            "metadata": metadata or {}
        })
        self.updated_at = datetime.now()
    
    def get_filters(self) -> Dict[str, Any]:
        """–ü–æ–ª—É—á–∏—Ç—å —Ñ–∏–ª—å—Ç—Ä—ã –¥–ª—è RAG –Ω–∞ –æ—Å–Ω–æ–≤–µ –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞"""
        filters = {}
        
        if self.current_problem_type:
            filters["problem_type"] = self.current_problem_type
        
        if self.printer_model:
            filters["printer_models"] = [self.printer_model]
        
        if self.material:
            filters["materials"] = [self.material]
        
        if self.print_stage:
            filters["print_stage"] = [self.print_stage]
        
        return filters
```

### 3.4 –í–∑–∞–∏–º–æ–¥–µ–π—Å—Ç–≤–∏–µ –∞–≥–µ–Ω—Ç–æ–≤

**–ü—Ä–∏–º–µ—Ä –ø–æ—Ç–æ–∫–∞:**

```python
class OrchestratorAgent:
    def __init__(self, vision_agent, diagnostic_agent, retrieval_agent):
        self.vision = vision_agent
        self.diagnostic = diagnostic_agent
        self.retrieval = retrieval_agent
    
    async def process_request(
        self, 
        user_input: str, 
        image: Optional[bytes],
        context: SessionContext
    ) -> Dict[str, Any]:
        """–û–±—Ä–∞–±–æ—Ç–∫–∞ –∑–∞–ø—Ä–æ—Å–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è"""
        
        # 1. –û–±—Ä–∞–±–æ—Ç–∫–∞ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è (–µ—Å–ª–∏ –µ—Å—Ç—å)
        if image:
            vision_result = await self.vision.analyze_image(image, context)
            context.vision_result = vision_result
            context.current_problem_type = vision_result.get("problem_type")
            
            # –û–±–Ω–æ–≤–ª—è–µ–º user_input —Å —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞–º–∏ –∞–Ω–∞–ª–∏–∑–∞
            user_input += f" {vision_result.get('description', '')}"
        
        # 2. –î–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞
        diagnostic_result = await self.diagnostic.diagnose(user_input, context)
        context.diagnostic_state = diagnostic_result["state"]
        
        # 3. –ü–æ–∏—Å–∫ –≤ KB (–µ—Å–ª–∏ –Ω—É–∂–Ω–æ)
        if diagnostic_result["needs_kb_search"]:
            filters = context.get_filters()
            search_results = await self.retrieval.search(
                query=user_input,
                filters=filters,
                limit=5
            )
            context.retrieved_articles = search_results
        
        # 4. –§–æ—Ä–º–∏—Ä–æ–≤–∞–Ω–∏–µ –æ—Ç–≤–µ—Ç–∞
        response = await self._formulate_response(context, diagnostic_result)
        
        # 5. –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞
        context.add_message("user", user_input)
        context.add_message("assistant", response["text"])
        
        return response
    
    async def _formulate_response(
        self, 
        context: SessionContext, 
        diagnostic_result: Dict
    ) -> Dict[str, Any]:
        """–§–æ—Ä–º–∏—Ä–æ–≤–∞–Ω–∏–µ —Ñ–∏–Ω–∞–ª—å–Ω–æ–≥–æ –æ—Ç–≤–µ—Ç–∞"""
        
        # –ï—Å–ª–∏ –µ—Å—Ç—å –≤–æ–ø—Ä–æ—Å—ã –¥–ª—è —É—Ç–æ—á–Ω–µ–Ω–∏—è
        if diagnostic_result.get("questions"):
            return {
                "type": "clarification",
                "text": diagnostic_result["questions"][0],
                "questions": diagnostic_result["questions"]
            }
        
        # –ï—Å–ª–∏ –µ—Å—Ç—å —Ä–µ—à–µ–Ω–∏–µ
        if diagnostic_result.get("solution"):
            articles = context.retrieved_articles or []
            return {
                "type": "solution",
                "text": diagnostic_result["solution"],
                "articles": articles,
                "confidence": diagnostic_result.get("confidence", 0.0)
            }
        
        return {
            "type": "unknown",
            "text": "–ù–µ —É–¥–∞–ª–æ—Å—å –æ–ø—Ä–µ–¥–µ–ª–∏—Ç—å –ø—Ä–æ–±–ª–µ–º—É. –ú–æ–∂–µ—Ç–µ –æ–ø–∏—Å–∞—Ç—å –ø–æ–¥—Ä–æ–±–Ω–µ–µ?"
        }
```

### 3.5 –°–æ–≥–ª–∞—Å–æ–≤–∞–Ω–Ω–æ—Å—Ç—å –º–µ—Ç–∞–¥–∞–Ω–Ω—ã—Ö

**–ï–¥–∏–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç –º–µ—Ç–∞–¥–∞–Ω–Ω—ã—Ö:**

```python
ARTICLE_METADATA_SCHEMA = {
    "problem_type": str,  # "stringing", "warping", etc.
    "printer_models": List[str],  # ["Ender-3", "Ender-3 V2"]
    "materials": List[str],  # ["PLA", "PETG"]
    "symptoms": List[str],  # ["–Ω–∏—Ç–æ—á–∫–∏", "—Å–æ–ø–ª–∏"]
    "print_stage": List[str],  # ["first_layer", "infill"]
    "solutions": List[Dict],  # [{"parameter": "...", "value": ...}]
    "related_problems": List[str]  # ["warping", "overheating"]
}

def validate_metadata(metadata: dict) -> bool:
    """–í–∞–ª–∏–¥–∞—Ü–∏—è –º–µ—Ç–∞–¥–∞–Ω–Ω—ã—Ö"""
    for key, expected_type in ARTICLE_METADATA_SCHEMA.items():
        if key not in metadata:
            continue  # –û–ø—Ü–∏–æ–Ω–∞–ª—å–Ω—ã–µ –ø–æ–ª—è
        
        value = metadata[key]
        if expected_type == List[str]:
            if not isinstance(value, list) or not all(isinstance(v, str) for v in value):
                return False
        elif expected_type == str:
            if not isinstance(value, str):
                return False
    
    return True
```

### 3.6 –û–±—Ä–∞–±–æ—Ç–∫–∞ –∫–æ–Ω—Ñ–ª–∏–∫—Ç–æ–≤

**–°—Ç—Ä–∞—Ç–µ–≥–∏—è —Ä–∞–∑—Ä–µ—à–µ–Ω–∏—è –∫–æ–Ω—Ñ–ª–∏–∫—Ç–æ–≤:**

```python
class ConflictResolver:
    def resolve_vision_diagnostic_conflict(
        self, 
        vision_result: Dict, 
        diagnostic_result: Dict
    ) -> Dict:
        """–†–∞–∑—Ä–µ—à–µ–Ω–∏–µ –∫–æ–Ω—Ñ–ª–∏–∫—Ç–∞ –º–µ–∂–¥—É Vision –∏ Diagnostic –∞–≥–µ–Ω—Ç–∞–º–∏"""
        
        vision_problem = vision_result.get("problem_type")
        diagnostic_problem = diagnostic_result.get("problem_type")
        
        if vision_problem == diagnostic_problem:
            return {
                "resolved": True,
                "problem_type": vision_problem,
                "confidence": max(
                    vision_result.get("confidence", 0.0),
                    diagnostic_result.get("confidence", 0.0)
                )
            }
        
        # –ö–æ–Ω—Ñ–ª–∏–∫—Ç: —Ä–∞–∑–Ω—ã–µ –ø—Ä–æ–±–ª–µ–º—ã
        # –ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç: Vision (–µ—Å–ª–∏ —É–≤–µ—Ä–µ–Ω–Ω–æ—Å—Ç—å –≤—ã—Å–æ–∫–∞—è)
        if vision_result.get("confidence", 0.0) > 0.8:
            return {
                "resolved": True,
                "problem_type": vision_problem,
                "confidence": vision_result.get("confidence", 0.0),
                "note": "–ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç Vision Agent (–≤—ã—Å–æ–∫–∞—è —É–≤–µ—Ä–µ–Ω–Ω–æ—Å—Ç—å)"
            }
        
        # –ò–Ω–∞—á–µ –∑–∞–ø—Ä–∞—à–∏–≤–∞–µ–º —É—Ç–æ—á–Ω–µ–Ω–∏–µ —É –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
        return {
            "resolved": False,
            "conflict": True,
            "vision_suggestion": vision_problem,
            "diagnostic_suggestion": diagnostic_problem,
            "question": f"–ü–æ —Ñ–æ—Ç–æ –ø–æ—Ö–æ–∂–µ –Ω–∞ '{vision_problem}', –Ω–æ –ø–æ –æ–ø–∏—Å–∞–Ω–∏—é - '{diagnostic_problem}'. –ß—Ç–æ –∏–º–µ–Ω–Ω–æ –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç?"
        }
```

---

## 4. –ü–ª–∞–Ω —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏

### –≠—Ç–∞–ø 1: –ü–∞—Ä—Å–µ—Ä (1-2 –Ω–µ–¥–µ–ª–∏)

1. **–°—Ç—Ä—É–∫—Ç—É—Ä–Ω–∞—è —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏—è** (2-3 –¥–Ω—è)
   - –†–µ–∞–ª–∏–∑–∞—Ü–∏—è `SectionFilter`
   - –ü–∞—Ä—Å–∏–Ω–≥ —Å—Ç—Ä—É–∫—Ç—É—Ä—ã —Å–∞–π—Ç–∞
   - –§–∏–ª—å—Ç—Ä–∞—Ü–∏—è –ø–æ —Ä–∞–∑–¥–µ–ª–∞–º

2. **–ö–æ–Ω—Ç–µ–Ω—Ç–Ω–∞—è —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏—è** (3-4 –¥–Ω—è)
   - –†–µ–∞–ª–∏–∑–∞—Ü–∏—è `ContentRelevanceFilter`
   - –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å LLM –¥–ª—è –∞–Ω–∞–ª–∏–∑–∞
   - –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –Ω–∞ –≤—ã–±–æ—Ä–∫–µ —Å—Ç–∞—Ç–µ–π

3. **–ò–∑–≤–ª–µ—á–µ–Ω–∏–µ –º–µ—Ç–∞–¥–∞–Ω–Ω—ã—Ö** (2-3 –¥–Ω—è)
   - –†–µ–∞–ª–∏–∑–∞—Ü–∏—è `ArticleMetadataExtractor`
   - –ü–∞—Ä—Å–∏–Ω–≥ —Å—Ç—Ä—É–∫—Ç—É—Ä–∏—Ä–æ–≤–∞–Ω–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö
   - –í–∞–ª–∏–¥–∞—Ü–∏—è –º–µ—Ç–∞–¥–∞–Ω–Ω—ã—Ö

### –≠—Ç–∞–ø 2: –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ KB (1 –Ω–µ–¥–µ–ª—è)

1. **–ì–µ–Ω–µ—Ä–∞—Ü–∏—è —Ç–µ—Å—Ç–æ–≤—ã—Ö –≤–æ–ø—Ä–æ—Å–æ–≤** (2-3 –¥–Ω—è)
   - –†–µ–∞–ª–∏–∑–∞—Ü–∏—è `RelevanceTestGenerator`
   - –°–æ–∑–¥–∞–Ω–∏–µ —Ç–µ—Å—Ç–æ–≤–æ–≥–æ –Ω–∞–±–æ—Ä–∞
   - –í–∞–ª–∏–¥–∞—Ü–∏—è –≤–æ–ø—Ä–æ—Å–æ–≤

2. **–¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ** (2-3 –¥–Ω—è)
   - –†–µ–∞–ª–∏–∑–∞—Ü–∏—è `KBRelevanceTester`
   - –ó–∞–ø—É—Å–∫ —Ç–µ—Å—Ç–æ–≤
   - –ê–Ω–∞–ª–∏–∑ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤

3. **–ò—Ç–µ—Ä–∞—Ç–∏–≤–Ω–æ–µ —É–ª—É—á—à–µ–Ω–∏–µ** (1-2 –¥–Ω—è)
   - –†–µ–∞–ª–∏–∑–∞—Ü–∏—è `KBIterativeImprover`
   - –ì–µ–Ω–µ—Ä–∞—Ü–∏—è —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–π
   - –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ KB

### –≠—Ç–∞–ø 3: –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞ –∞–≥–µ–Ω—Ç–æ–≤ (1 –Ω–µ–¥–µ–ª—è)

1. **SessionContext** (1-2 –¥–Ω—è)
   - –†–µ–∞–ª–∏–∑–∞—Ü–∏—è –∫–ª–∞—Å—Å–∞
   - –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å –∞–≥–µ–Ω—Ç–∞–º–∏
   - –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ

2. **Orchestrator Agent** (2-3 –¥–Ω—è)
   - –†–µ–∞–ª–∏–∑–∞—Ü–∏—è –∫–æ–æ—Ä–¥–∏–Ω–∞—Ü–∏–∏
   - –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫
   - Fallback –ª–æ–≥–∏–∫–∞

3. **–°–æ–≥–ª–∞—Å–æ–≤–∞–Ω–Ω–æ—Å—Ç—å** (1-2 –¥–Ω—è)
   - –í–∞–ª–∏–¥–∞—Ü–∏—è –º–µ—Ç–∞–¥–∞–Ω–Ω—ã—Ö
   - –†–∞–∑—Ä–µ—à–µ–Ω–∏–µ –∫–æ–Ω—Ñ–ª–∏–∫—Ç–æ–≤
   - –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –≤–∑–∞–∏–º–æ–¥–µ–π—Å—Ç–≤–∏—è

---

## 5. –ú–µ—Ç—Ä–∏–∫–∏ —É—Å–ø–µ—Ö–∞

### –ü–∞—Ä—Å–∏–Ω–≥
- ‚úÖ **–¢–æ—á–Ω–æ—Å—Ç—å —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏–∏:** > 90% —Ä–µ–ª–µ–≤–∞–Ω—Ç–Ω—ã—Ö —Å—Ç–∞—Ç–µ–π
- ‚úÖ **–ü–æ–∫—Ä—ã—Ç–∏–µ –º–µ—Ç–∞–¥–∞–Ω–Ω—ã—Ö:** > 80% —Å—Ç–∞—Ç–µ–π —Å –ø–æ–ª–Ω—ã–º–∏ –º–µ—Ç–∞–¥–∞–Ω–Ω—ã–º–∏
- ‚úÖ **–°–∫–æ—Ä–æ—Å—Ç—å –ø–∞—Ä—Å–∏–Ω–≥–∞:** > 10 —Å—Ç–∞—Ç–µ–π/–º–∏–Ω—É—Ç—É

### –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ KB
- ‚úÖ **Top-1 Hit Rate:** > 0.6
- ‚úÖ **Top-3 Hit Rate:** > 0.8
- ‚úÖ **Relevance Score:** > 0.7
- ‚úÖ **MRR:** > 0.7

### –ê–≥–µ–Ω—Ç—ã
- ‚úÖ **–°–æ–≥–ª–∞—Å–æ–≤–∞–Ω–Ω–æ—Å—Ç—å:** 100% (–Ω–µ—Ç –∫–æ–Ω—Ñ–ª–∏–∫—Ç–æ–≤ –º–µ—Ç–∞–¥–∞–Ω–Ω—ã—Ö)
- ‚úÖ **–í—Ä–µ–º—è –æ—Ç–≤–µ—Ç–∞:** < 5 —Å–µ–∫—É–Ω–¥
- ‚úÖ **–¢–æ—á–Ω–æ—Å—Ç—å –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∏:** > 0.8

